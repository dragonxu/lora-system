<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>MAC Command Organizer - Xis LoRa documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "MAC Command Organizer";
    var mkdocs_page_input_path = "Controller\\index.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Xis LoRa documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">Home</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="..">Home</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Install</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../install/">Install</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Network Server</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Server/">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../Server/http/">HTTP APIs</a>
                </li>
                <li class="">
                    
    <a class="" href="../Server/DataFormat/">Data Format</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Network Controller</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">MAC Command Organizer</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#mac-command-organizer">MAC Command Organizer</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#1-mac-command-queue">1. MAC Command Queue</a></li>
        
            <li><a class="toctree-l4" href="#2-downlink-mac-command-algorithm">2. Downlink MAC Command Algorithm</a></li>
        
            <li><a class="toctree-l4" href="#3-uplink-mac-command-algorithm">3. Uplink MAC Command Algorithm</a></li>
        
            <li><a class="toctree-l4" href="#4-network-server-and-network-controller-interactive-data-format">4. Network Server and Network Controller Interactive Data Format</a></li>
        
            <li><a class="toctree-l4" href="#5-introduction">5. Introduction</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Xis LoRa documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Network Controller &raquo;</li>
        
      
    
    <li>MAC Command Organizer</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="mac-command-organizer">MAC Command Organizer</h1>
<p>The Network Server and the Network Controller implement the organization of the MAC Command.</p>
<h2 id="1-mac-command-queue">1. MAC Command Queue</h2>
<p>For each end-device, the Network Controller maintains a MAC Command queue with each element in the queue as shown in the following TABLE 1.
<center>TABLE 1 Field Description of MAC Command Queue</center></p>
<table>
<thead>
<tr>
<th align="center">Field</th>
<th align="center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">CID</td>
<td align="center">MAC Command ID</td>
</tr>
<tr>
<td align="center">Payload</td>
<td align="center">Byte sequence that Command may contain</td>
</tr>
</tbody>
</table>
<h2 id="2-downlink-mac-command-algorithm">2. Downlink MAC Command Algorithm</h2>
<h3 id="21-mac-command-req-downlink-algorithm">2.1 MAC Command Req Downlink Algorithm</h3>
<p>The algorithm takes the time when uplink packet arrives as the start of the loop.</p>
<ol>
<li>
<p>Once the uplink data arrives, if the packet contains the MAC Command, the Network Server extracts the part and sends it to the Network Controller by an array;</p>
</li>
<li>
<p>The Network Controller will read all the commands in the MAC Command Queue, and put them into the array Q, then traverse the array Q, then delete all Ans;</p>
</li>
<li>
<p>The MAC Command in the data packet which the Network Controller receives contains Ans and Req, and the Network Controller will traverse all the data packet;</p>
</li>
<li>
<p>When Encountering MAC Command Ans, the Network Controller will compare it with the MAC Command Req of the array Q, and record the position of the first unmatched Ans-Req pair as d;</p>
</li>
<li>
<p>When Encountering MAC Command Req, the Network Controller will processe it;</p>
</li>
<li>
<p>Clear the original MAC Command queue, and push all elements of array Q from position d into the new MAC Command queue;</p>
</li>
<li>
<p>Traverse MAC Command Req Queue and application data Queue;</p>
</li>
<li>
<p>Construct downlink data according to the TABLE 2 policy and send it to the Network Connector by Network Server;</p>
</li>
<li>
<p>The Network Connector encapsulates the LoRa packet and delivers it to the gateway.</p>
</li>
</ol>
<p><center>TABLE 2 Downlink MAC Command and Application Data Group Package Policy</center></p>
<table>
<thead>
<tr>
<th align="center">Downlink Application Data</th>
<th align="center">Downlink MAC Commands</th>
<th align="center">Send Downlink Packet</th>
<th align="center">FOpts</th>
<th align="center">FRMPayload</th>
<th align="center">Other</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">not have</td>
<td align="center">not have</td>
<td align="center">no</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">have</td>
<td align="center">not have</td>
<td align="center">yes</td>
<td align="center">null</td>
<td align="center">Application Data</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">not have</td>
<td align="center">have(&gt; 15 bytes)</td>
<td align="center">yes</td>
<td align="center">null</td>
<td align="center">MAC</td>
<td align="center">FPort = 0</td>
</tr>
<tr>
<td align="center">not have</td>
<td align="center">have(&lt;= 15 bytes)</td>
<td align="center">yes</td>
<td align="center">MAC</td>
<td align="center">null</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">have</td>
<td align="center">have(&gt; 15 bytes)</td>
<td align="center">yes</td>
<td align="center">null</td>
<td align="center">MAC</td>
<td align="center">FPort = 0</br>FPending = 1</td>
</tr>
<tr>
<td align="center">have</td>
<td align="center">have(&lt;= 15 bytes)</td>
<td align="center">yes</td>
<td align="center">null</td>
<td align="center">Application Data</td>
<td align="center">-</td>
</tr>
</tbody>
</table>
<p><img alt="MAC Command Queue Schematic Diagram" src="https://github.com/xisiot/resources/blob/master/lora-system/images/MACCommandQueue.png" /></p>
<h3 id="22-boundary-or-special-circumstances">2.2 Boundary or Special Circumstances</h3>
<ul>
<li>
<p>RXParamSetupAns, RXTimingSetupAns, DlChannelAns three types MAC Command（TBD）</p>
</li>
<li>
<p>Version Issue</p>
</li>
</ul>
<p>The server is based on LoRaWAN 1.1 protocol. Before issuing the MAC Command downlink,checking the LoRaWAN version supported by the device is principal. If the LoRaWAN version of device is out of support version,the MAC Command is directly removed from the queue.</p>
<ul>
<li>
<p>The total number of bytes of the MAC Command Queue exceeds 15 bytes, does not exceed the maximum allowed by FRMPayload, and there is data in the application data queue</p>
</li>
<li>
<p>Command Req is all placed in FRMPayload</p>
</li>
<li>FPort = 0</li>
<li>
<p>FPending = 1 </p>
</li>
<li>
<p>The total number of bytes in the MAC Command Queue exceeds the maximum allowed by FRMPayload</p>
</li>
<li>Keep the last Command Req not sent</li>
<li>FPending = 1</li>
</ul>
<h2 id="3-uplink-mac-command-algorithm">3. Uplink MAC Command Algorithm</h2>
<h2 id="4-network-server-and-network-controller-interactive-data-format">4. Network Server and Network Controller Interactive Data Format</h2>
<h3 id="41-uplinknetwork-server-to-network-controller">4.1 Uplink(Network Server to Network Controller)</h3>
<p>The Network Server sends the uplink MAC Command and the transmission parameters which can be useful in the Network Controller. The data format is as follows.</p>
<pre><code class="json">{
  &quot;DevAddr&quot;: &quot;&quot;,
  &quot;data&quot;: &quot;&quot;,
  &quot;adr&quot;: &quot;&quot;,
  &quot;devtx&quot;:
    {
      &quot;freq&quot;: &quot;&quot;,
      &quot;datr&quot;: &quot;&quot;,
      &quot;codr&quot;: &quot;&quot;,
    },
  &quot;gwrx&quot;: [
    {
      &quot;gatewayId&quot;: &quot;&quot;,
      &quot;time&quot;: &quot;&quot;,
      &quot;tmst&quot;: &quot;&quot;,
      &quot;chan&quot;: &quot;&quot;,
      &quot;rfch&quot;: &quot;&quot;,
      &quot;stat&quot;: &quot;&quot;,
      &quot;modu&quot;: &quot;&quot;,
      &quot;rssi&quot;: &quot;&quot;,
      &quot;lsnr&quot;: &quot;&quot;,
      &quot;size&quot;: &quot;&quot;,
    },
  ],
}
</code></pre>

<p>The field description of uplink data is shown in the following TABLE 3.</p>
<p><center>TABLE 3 Field Description of Uplink Data Format</center></p>
<table>
<thead>
<tr>
<th align="center">Field</th>
<th align="center">Type</th>
<th align="center">Example</th>
<th align="center">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">DevAddr</td>
<td align="center">Buffer</td>
<td align="center">&lt;Buffer 00 96 44 72&gt;</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">data</td>
<td align="center">Array</td>
<td align="center">Explained below</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">ADR</td>
<td align="center">Bool</td>
<td align="center">true/false</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">devtx</td>
<td align="center">Object</td>
<td align="center">Table 4 for instructions</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">gwrx</td>
<td align="center">Array</td>
<td align="center">Table 5 for instructions</td>
<td align="center">Yes</td>
</tr>
</tbody>
</table>
<p><center>Description of data Field</center></p>
<pre><code class="json">[
  {
    &quot;0x01&quot;: { &quot;Version&quot;: &lt;Buffer 02&gt;, },
  },
  {
    &quot;0x02&quot;: null,
  },
  {
    &quot;0x03&quot;: { &quot;Status&quot;: &lt;Buffer 02&gt;, },
  },
]

</code></pre>

<p><center>TABLE 4 Description of devtx Field </center></p>
<table>
<thead>
<tr>
<th align="center">Field</th>
<th align="center">Type</th>
<th align="center">Example</th>
<th align="center">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">freq</td>
<td align="center">Number</td>
<td align="center">433.3</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">datr</td>
<td align="center">String</td>
<td align="center">"SF7BW125"</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">codr</td>
<td align="center">String</td>
<td align="center">"4/6"</td>
<td align="center">Yes</td>
</tr>
</tbody>
</table>
<p><center>TABLE 5 Description of gwrx Field </center></p>
<table>
<thead>
<tr>
<th align="center">Field</th>
<th align="center">Type</th>
<th align="center">Example</th>
<th align="center">Required</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">gatewayId</td>
<td align="center">Buffer</td>
<td align="center">&lt;Buffer b8 27 ed ff fe 52 0e 51&gt;</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">time</td>
<td align="center">String</td>
<td align="center">"2013-03-31T16:21:17.528002Z"</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">tmst</td>
<td align="center">Number</td>
<td align="center">3512348611</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">chan</td>
<td align="center">Number</td>
<td align="center">2</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">rfch</td>
<td align="center">Number</td>
<td align="center">0</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">stat</td>
<td align="center">Number</td>
<td align="center">1</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">modu</td>
<td align="center">String</td>
<td align="center">"LORA"</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">rssi</td>
<td align="center">Number</td>
<td align="center">-35</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">lsnr</td>
<td align="center">Number</td>
<td align="center">5.1</td>
<td align="center">Yes</td>
</tr>
<tr>
<td align="center">size</td>
<td align="center">Number</td>
<td align="center">32</td>
<td align="center">Yes</td>
</tr>
</tbody>
</table>
<h3 id="42-downlinknetwork-controller-to-network-server">4.2 Downlink(Network Controller to Network Server)</h3>
<p>The downlink MAC Command that the Network Controller will send is stored in the Redis queue as Json format.</p>
<pre><code class="json"> {
    &quot;cid&quot;: &quot;payload&quot;,
  }

</code></pre>

<p><em>Example</em></p>
<pre><code class="json">{
    &quot;0x01&quot;: { &quot;Version&quot;: &lt;Buffer 02&gt;, },
  }

</code></pre>

<p>The MAC Command field definition is shown in the following TABLE 6.</p>
<p><center>TABLE 6 Description of MAC Command Field</center></p>
<table>
<thead>
<tr>
<th align="center">cid</th>
<th align="center">MAC Command</th>
<th align="center">payload</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0x01</td>
<td align="center">ResetInd</td>
<td align="center">Version</td>
</tr>
<tr>
<td align="center">0x01</td>
<td align="center">ResetConf</td>
<td align="center">Version</td>
</tr>
<tr>
<td align="center">0x02</td>
<td align="center">LinkCheckReq</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x02</td>
<td align="center">LinkCheckAns</td>
<td align="center">Margin<br> GwCnt</td>
</tr>
<tr>
<td align="center">0x03</td>
<td align="center">LinkADRReq</td>
<td align="center">TXPower<br>ChMask<br>Redundancy</td>
</tr>
<tr>
<td align="center">0x03</td>
<td align="center">LinkADRAns</td>
<td align="center">Status</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">DutyCycleReq</td>
<td align="center">DutyCyclePL</td>
</tr>
<tr>
<td align="center">0x04</td>
<td align="center">DutyCycleAns</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x05</td>
<td align="center">RXParamSetupReq</td>
<td align="center">DLSettings<br>Frequency</td>
</tr>
<tr>
<td align="center">0x05</td>
<td align="center">RXParamSetupAns</td>
<td align="center">Status</td>
</tr>
<tr>
<td align="center">0x06</td>
<td align="center">DevStatusReq</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x06</td>
<td align="center">DevStatusAns</td>
<td align="center">Battery<br>Margin</td>
</tr>
<tr>
<td align="center">0x07</td>
<td align="center">NewChannelReq</td>
<td align="center">ChIndex<br>Freq<br>DrRange</td>
</tr>
<tr>
<td align="center">0x07</td>
<td align="center">NewChannelAns</td>
<td align="center">Status</td>
</tr>
<tr>
<td align="center">0x08</td>
<td align="center">RXTimingSetupReq</td>
<td align="center">Settings</td>
</tr>
<tr>
<td align="center">0x08</td>
<td align="center">RXTimingSetupAns</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x09</td>
<td align="center">TxParamSetupReq</td>
<td align="center">DwellTime</td>
</tr>
<tr>
<td align="center">0x09</td>
<td align="center">TxParamSetupAns</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x0A</td>
<td align="center">DlChannelReq</td>
<td align="center">ChIndex<br>Freq</td>
</tr>
<tr>
<td align="center">0x0A</td>
<td align="center">DlChannelAns</td>
<td align="center">Status</td>
</tr>
<tr>
<td align="center">0x0B</td>
<td align="center">RekeyInd</td>
<td align="center">Version</td>
</tr>
<tr>
<td align="center">0x0B</td>
<td align="center">RekeyConf</td>
<td align="center">Version</td>
</tr>
<tr>
<td align="center">0x0C</td>
<td align="center">ADRParamSetupReq</td>
<td align="center">ADRParam</td>
</tr>
<tr>
<td align="center">0x0C</td>
<td align="center">ADRParamSetupAns</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x0D</td>
<td align="center">DeviceTimeReq</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">0x0D</td>
<td align="center">DeviceTimeAns</td>
<td align="center">Seconds<br>FractionalSec</td>
</tr>
<tr>
<td align="center">0x0E</td>
<td align="center">ForceRejoinReq</td>
<td align="center">ForceRejoinReq</td>
</tr>
<tr>
<td align="center">0x0F</td>
<td align="center">RejoinParamSetupReq</td>
<td align="center">RejoinParamSetupReq</td>
</tr>
<tr>
<td align="center">0x0F</td>
<td align="center">RejoinParamSetupAns</td>
<td align="center">Status</td>
</tr>
</tbody>
</table>
<h2 id="5-introduction">5. Introduction</h2>
<p>The Network Server and the Network Controller implement the organization of the MAC Command. The Network Controller implements the analysis of the uplink MAC Command and performs corresponding algorithm processing, and simultaneously delivers the downlink MAC Command command. The Network Controller includes processFlow Module, MAC Command Issuer and MAC Command Handler:</p>
<ul>
<li>processFlow Module</li>
</ul>
<p>The processFlow module is the core part of controller, which handles the MAC command part of each uplink data forwarded by the network server.The processing flow has been described in detail in the MAC Command Req Uplink Algorithm.</p>
<ul>
<li>MAC Command Issuer</li>
</ul>
<p>The MAC Command Issuer is used to initiate the MAC command, which is the form of the MAC command that the end-device can receive.</p>
<ul>
<li>MAC Command Handler</li>
</ul>
<p>The MAC command Handler is the processing of the MAC command in the uplink data.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../Server/DataFormat/" class="btn btn-neutral" title="Data Format"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Server/DataFormat/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
